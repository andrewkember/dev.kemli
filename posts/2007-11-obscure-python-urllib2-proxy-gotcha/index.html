<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Obscure python urllib2 proxy gotcha | Andrew Kember</title><meta name=keywords content><meta name=description content="This is going to be very obscure, technical and humourless1, so unless you suspect your environment-set http proxy is messing with your python, you can stop reading now.
This is actually two problems, and three solutions.
Problem 1 My python script bombs out with:
File &#34;c:\Python23\lib\urllib2.py&#34;, line 506, in proxy_open if '@' in host: TypeError: iterable argument required Solution 1 Your http_proxy environment variable must include http:// at the start."><meta name=author content="AK"><link rel=canonical href=https://blog.kember.net/posts/2007-11-obscure-python-urllib2-proxy-gotcha/><link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js integrity="sha256-uVus3DnjejMqn4g7Hni+Srwf3KK8HyZB9V4809q9TWE=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://blog.kember.net/static/images-header/ak-logo-2021-black-filled-optimised.svg><link rel=icon type=image/png sizes=16x16 href=https://blog.kember.net/static/images-header/ak-logo-2021-black-filled-optimised.svg><link rel=icon type=image/png sizes=32x32 href=https://blog.kember.net/static/images-header/ak-logo-2021-black-filled-optimised.svg><link rel=apple-touch-icon href=https://blog.kember.net/static/images-header/ak-logo-2021-black-filled-optimised.svg><link rel=mask-icon href=https://blog.kember.net/static/images-header/ak-logo-2021-black-filled-optimised.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><meta name=generator content="Hugo 0.107.0"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Obscure python urllib2 proxy gotcha"><meta property="og:description" content="This is going to be very obscure, technical and humourless1, so unless you suspect your environment-set http proxy is messing with your python, you can stop reading now.
This is actually two problems, and three solutions.
Problem 1 My python script bombs out with:
File &#34;c:\Python23\lib\urllib2.py&#34;, line 506, in proxy_open if '@' in host: TypeError: iterable argument required Solution 1 Your http_proxy environment variable must include http:// at the start."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.kember.net/posts/2007-11-obscure-python-urllib2-proxy-gotcha/"><meta property="og:image" content="https://blog.kember.net/static/images-header/ak-logo-2021-black-filled-optimised.svg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2007-11-21T19:28:08+00:00"><meta property="article:modified_time" content="2007-11-21T19:28:08+00:00"><meta property="og:site_name" content="Andrew Kember"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.kember.net/static/images-header/ak-logo-2021-black-filled-optimised.svg"><meta name=twitter:title content="Obscure python urllib2 proxy gotcha"><meta name=twitter:description content="This is going to be very obscure, technical and humourless1, so unless you suspect your environment-set http proxy is messing with your python, you can stop reading now.
This is actually two problems, and three solutions.
Problem 1 My python script bombs out with:
File &#34;c:\Python23\lib\urllib2.py&#34;, line 506, in proxy_open if '@' in host: TypeError: iterable argument required Solution 1 Your http_proxy environment variable must include http:// at the start."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.kember.net/posts/"},{"@type":"ListItem","position":2,"name":"Obscure python urllib2 proxy gotcha","item":"https://blog.kember.net/posts/2007-11-obscure-python-urllib2-proxy-gotcha/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Obscure python urllib2 proxy gotcha","name":"Obscure python urllib2 proxy gotcha","description":"This is going to be very obscure, technical and humourless1, so unless you suspect your environment-set http proxy is messing with your python, you can stop reading now.\nThis is actually two problems, and three solutions.\nProblem 1 My python script bombs out with:\nFile \u0026#34;c:\\Python23\\lib\\urllib2.py\u0026#34;, line 506, in proxy_open if \u0026#39;@\u0026#39; in host: TypeError: iterable argument required Solution 1 Your http_proxy environment variable must include http:// at the start.","keywords":[],"articleBody":"This is going to be very obscure, technical and humourless1, so unless you suspect your environment-set http proxy is messing with your python, you can stop reading now.\nThis is actually two problems, and three solutions.\nProblem 1 My python script bombs out with:\nFile \"c:\\Python23\\lib\\urllib2.py\", line 506, in proxy_open if '@' in host: TypeError: iterable argument required Solution 1 Your http_proxy environment variable must include http:// at the start.\nProblem 2 But why’s it happening in the first place? I’m not even using the environment-set proxy – I’m defining my own, thus:\nproxy_handler = urllib2.ProxyHandler({'http': 'http://myproxy.net:3128'}) opener = urllib2.build_opener() opener.add_handler(proxy_handler) Solution 2 Ah! But urllib2.build_opener() has a set of default handlers, one of which is a proxy handler. Guess what the default behaviour of the proxy handler is, when you don’t give it a proxy url? It gets it from the environment.\nSo you’re ending up with two proxy handlers. The default one gleaned from the environment, and your custom one. It seems that it only uses the custom one (try it using Wireshark) but it still processes the environment one. So if the format of the environment one is wrong, it breaks your script. This is a bit unpredictable and brittle, so try this instead:\nproxy_handler = urllib2.ProxyHandler({'http': 'http://myproxy.net:3128'}) opener = urllib2.build_opener(proxy_handler) That will give you one and only one proxy handler.\n[Updated 03/03/2008 to add] To get no proxies – i.e. to disable proxies, do this:\nproxy_support = urllib2.ProxyHandler({}) opener = urllib2.build_opener(proxy_support) urllib2.install_opener(opener) # Optional - makes this opener default for urlopen etc. Solution to end all solutions I tried this on Python 2.5 and it exhibited none of these problems. I’ve looked at the new urllib2 code which has much more detailed and careful proxy url parsing, allowing a more liberal approach to defining proxies.\n[Updated 09/03/2010 to add] Ciprian Trofin has emailed me to point out that while the parsing of proxy urls in environment variables improved in Python 2.5, the build_opener still uses default handlers, and gets its proxy from the environment, when none is specified. This is the case with Python 2.6 – I guess it’s an awkward feature, not actually a bug. Thanks to Ciprian for the update and clarification!\nOkay – we’re done. You can look at funny things now. ↩︎\n","wordCount":"379","inLanguage":"en","datePublished":"2007-11-21T19:28:08Z","dateModified":"2007-11-21T19:28:08Z","author":{"@type":"Person","name":"AK"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.kember.net/posts/2007-11-obscure-python-urllib2-proxy-gotcha/"},"publisher":{"@type":"Organization","name":"Andrew Kember","logo":{"@type":"ImageObject","url":"https://blog.kember.net/static/images-header/ak-logo-2021-black-filled-optimised.svg"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://blog.kember.net/ accesskey=h title="Andrew Kember (Alt + H)"><svg xmlns="http://www.w3.org/2000/svg" width="55" height="55" viewBox="0 0 202.02 202.02" style="vertical-align:middle"><g transform="translate(-3.65 -3.93)"><circle style="opacity:1;fill:none;fill-opacity:1;stroke:currentColor;stroke-width:16;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1" cx="104.66" cy="104.94" r="93.01"/></g><g style="display:inline;fill:currentColor;fill-opacity:1;stroke:none"><path d="m242.73 334.58 28.99-2.5-.77 48q-.19 4.8.2 8.45.38 3.26 1.15 5.76.76 2.5 2.5 2.5 1.53.0 2.49-1.93 1.15-2.1 1.73-4.6.76-2.88.96-6.72h8.25q.58 2.68.58 5.95.0 2.69-.58 6.53-.57 3.84-2.5 8.25-1.53 4.61-3.83 7.68-2.12 3.07-4.8 5-2.5 1.91-5.19 2.87t-5.18 1.54q-2.69.38-6.91-1.34-4.04-1.73-8.07-4.04-4.8-2.68-9.98-6.14-4.42 2.88-7.87 5.18-3.08 2.12-6.15 4.04-2.88 1.92-4.03 2.3-.96.38-4.42 1.34-3.45.96-8.44.77-5 0-11.14-2.3-6.14-2.11-12.29-8.07-6.33-6.14-9.02-13.24-2.69-7.3-3.65-13.44-.96-7.3.0-14.4.38-8.26 2.69-15.94 2.11-6.53 6.33-13.44 4.42-6.91 12.48-11.33 8.07-4.41 15.94-3.84 8.06.39 14.4 2.5 7.49 2.5 14.4 7.3zm-19.01 12.28q-5.57.0-9.4 6.15-3.85 6.14-3.85 18.24.0 12.48 3.84 19.2 3.84 6.72 9.41 6.72t9.8-6.72q4.22-6.72 4.22-19.2.0-12.1-4.23-18.24-4.22-6.15-9.79-6.15z" style="font-size:192px" transform="translate(-82.94 -145.69) scale(.6706)" aria-label="a"/><path d="M217.2 420.6h-42.63v-16.14q3.84.2 6.72-.57 2.5-.77 4.41-2.69 2.12-2.11 1.73-6.34v-19.39q.2-6.91.2-14.78.19-8.07.19-16.13.19-18.82.38-41.28l29-12.1v74.12q2.87.19 5.75-.2 2.5-.38 5-.96 2.49-.57 4.41-2.1 3.07-3.08 1.92-6.34-1.15-3.46-8.26-3.46l.77-11.14 43.2-.96q1.73 10.37.77 18.82-.38 3.65-1.54 7.1-.96 3.46-2.88 6.34t-4.99 4.8-7.3 2.3l29 40.13-38.6.96-19.39-23.23q-2.3-1.54-4.03-1.92-1.53-.38-2.69.38-1.15.77-1.15 3.84z" style="font-size:192px" transform="translate(-21.52 -145.16) scale(.6706)" aria-label="k"/></g></svg></a></div><ul id=menu><li><a href=https://blog.kember.net/about/ title=About><span>About</span></a></li><li><a href=https://blog.kember.net/commonplace/ title=Commonplace><span>Commonplace</span></a></li><li><a href=https://blog.kember.net/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><span class=logo-switches>&nbsp;|
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://blog.kember.net/>Home</a>&nbsp;»&nbsp;<a href=https://blog.kember.net/posts/>Posts</a></div><h1 class=post-title>Obscure python urllib2 proxy gotcha</h1><div class=post-meta><span title='2007-11-21 19:28:08 +0000 UTC'>November 21, 2007</span>&nbsp;·&nbsp;AK</div></header><div class=post-content><p>This is going to be very obscure, technical and humourless<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, so unless you suspect your environment-set http proxy is messing with your python, you can stop reading now.</p><p>This is actually two problems, and three solutions.</p><h2 id=problem-1>Problem 1<a hidden class=anchor aria-hidden=true href=#problem-1>#</a></h2><p>My python script bombs out with:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span>File <span style=color:#e6db74>&#34;c:\Python23\lib\urllib2.py&#34;</span>, line <span style=color:#ae81ff>506</span>, <span style=color:#f92672>in</span> proxy_open
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;@&#39;</span> <span style=color:#f92672>in</span> host:
</span></span><span style=display:flex><span><span style=color:#a6e22e>TypeError</span>: iterable argument required
</span></span></code></pre></div><h2 id=solution-1>Solution 1<a hidden class=anchor aria-hidden=true href=#solution-1>#</a></h2><p>Your <code>http_proxy</code> environment variable must include <code>http://</code> at the start.</p><h2 id=problem-2>Problem 2<a hidden class=anchor aria-hidden=true href=#problem-2>#</a></h2><p>But why’s it happening in the first place? I’m not even <em>using</em> the environment-set proxy – I’m defining my own, thus:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>
</span></span><span style=display:flex><span>proxy_handler <span style=color:#f92672>=</span> urllib2<span style=color:#f92672>.</span>ProxyHandler({<span style=color:#e6db74>&#39;http&#39;</span>: <span style=color:#e6db74>&#39;http://myproxy.net:3128&#39;</span>})
</span></span><span style=display:flex><span>opener <span style=color:#f92672>=</span> urllib2<span style=color:#f92672>.</span>build_opener()
</span></span><span style=display:flex><span>opener<span style=color:#f92672>.</span>add_handler(proxy_handler)
</span></span></code></pre></div><h2 id=solution-2>Solution 2<a hidden class=anchor aria-hidden=true href=#solution-2>#</a></h2><p>Ah! But <code>urllib2.build_opener()</code> has a set of default handlers, one of which is a proxy handler. Guess what the default behaviour of the proxy handler is, when you don’t give it a proxy url? It gets it from the environment.</p><p>So you’re ending up with <em>two</em> proxy handlers. The default one gleaned from the environment, and your custom one. It seems that it only uses the custom one (try it using <a href=http://www.wireshark.org/>Wireshark</a>) but it still processes the environment one. So if the format of the environment one is wrong, it breaks your script. This is a bit unpredictable and brittle, so try this instead:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>proxy_handler <span style=color:#f92672>=</span> urllib2<span style=color:#f92672>.</span>ProxyHandler({<span style=color:#e6db74>&#39;http&#39;</span>: <span style=color:#e6db74>&#39;http://myproxy.net:3128&#39;</span>})
</span></span><span style=display:flex><span>opener <span style=color:#f92672>=</span> urllib2<span style=color:#f92672>.</span>build_opener(proxy_handler)
</span></span></code></pre></div><p>That will give you one and only one proxy handler.</p><h2 id=updated-03032008-to-add>[Updated 03/03/2008 to add]<a hidden class=anchor aria-hidden=true href=#updated-03032008-to-add>#</a></h2><p>To get <em>no</em> proxies – i.e. to disable proxies, do this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>proxy_support <span style=color:#f92672>=</span> urllib2<span style=color:#f92672>.</span>ProxyHandler({})
</span></span><span style=display:flex><span>opener <span style=color:#f92672>=</span> urllib2<span style=color:#f92672>.</span>build_opener(proxy_support)
</span></span><span style=display:flex><span>urllib2<span style=color:#f92672>.</span>install_opener(opener)    <span style=color:#75715e># Optional - makes this opener default for urlopen etc.</span>
</span></span></code></pre></div><h2 id=solution-to-end-all-solutions>Solution to end all solutions<a hidden class=anchor aria-hidden=true href=#solution-to-end-all-solutions>#</a></h2><p>I tried this on Python 2.5 and it exhibited none of these problems. I’ve looked at the new urllib2 code which has much more detailed and careful proxy url parsing, allowing a more liberal approach to defining proxies.</p><h2 id=updated-09032010-to-add>[Updated 09/03/2010 to add]<a hidden class=anchor aria-hidden=true href=#updated-09032010-to-add>#</a></h2><p>Ciprian Trofin has emailed me to point out that while the parsing of proxy urls in environment variables improved in Python 2.5, the <code>build_opener</code> still uses default handlers, and gets its proxy from the environment, when none is specified. This is the case with Python 2.6 – I guess it’s an awkward feature, not actually a bug. Thanks to Ciprian for the update and clarification!</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Okay – we’re done. You can look at <a href=http://xkcd.com/282/>funny things</a> now.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><nav class=paginav><a class=prev href=https://blog.kember.net/posts/2008-04-reisub-the-gentle-linux-restart/><span class=title>« Prev Page</span><br><span>REISUB - the gentle Linux restart</span></a>
<a class=next href=https://blog.kember.net/posts/2007-09-does-alcohol-really-boil-away-in-cooking/><span class=title>Next Page »</span><br><span>Does Alcohol Really Boil Away In Cooking?</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://blog.kember.net/>Andrew Kember</a></span>
<span>&mdash; Obfuscation is Easy</span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>